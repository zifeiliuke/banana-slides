# 多用户体系完整设计方案

## 一、需求概述

### 1.1 背景
- 当前系统为单用户模式（Single Tenant），所有数据保存在 SQLite 中且无归属权
- 需要实现公司内部多用户登录，每个用户的数据（Project, Page, Templates）严格隔离

### 1.2 核心需求
| 需求项 | 描述 |
|--------|------|
| 认证方式 | 用户名 + 密码 |
| 用户等级 | 普通用户（free）、高级用户（premium） |
| Settings 策略 | 普通用户必须配置自己的 API Key；高级用户可使用全局共享配置 |
| 会员期限 | 订阅制，有期限，到期自动降级 |
| 充值方式 | 充值码/卡密 + 管理员手动升级 |
| 管理后台 | 需要（用户管理、充值码管理） |

---

## 二、数据库模型设计

### 2.1 新增表

#### User（用户表）
```sql
CREATE TABLE users (
    id              VARCHAR(36) PRIMARY KEY,
    username        VARCHAR(50) UNIQUE NOT NULL,
    email           VARCHAR(100) UNIQUE,
    password_hash   VARCHAR(256) NOT NULL,
    role            VARCHAR(20) NOT NULL DEFAULT 'user',    -- 'user' | 'admin'
    tier            VARCHAR(20) NOT NULL DEFAULT 'free',    -- 'free' | 'premium'
    premium_expires_at DATETIME,                            -- 高级会员过期时间
    is_active       BOOLEAN NOT NULL DEFAULT 1,
    created_at      DATETIME NOT NULL,
    updated_at      DATETIME NOT NULL,
    last_login_at   DATETIME
);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_tier ON users(tier);
```

#### UserSettings（用户个人设置表）
```sql
CREATE TABLE user_settings (
    id                  VARCHAR(36) PRIMARY KEY,
    user_id             VARCHAR(36) UNIQUE NOT NULL,
    ai_provider_format  VARCHAR(20) DEFAULT 'gemini',
    api_base_url        VARCHAR(500),
    api_key             VARCHAR(500),
    text_model          VARCHAR(100),
    image_model         VARCHAR(100),
    image_caption_model VARCHAR(100),
    created_at          DATETIME NOT NULL,
    updated_at          DATETIME NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### RechargeCode（充值码表）
```sql
CREATE TABLE recharge_codes (
    id                  VARCHAR(36) PRIMARY KEY,
    code                VARCHAR(32) UNIQUE NOT NULL,
    duration_days       INTEGER NOT NULL,               -- 充值天数
    is_used             BOOLEAN NOT NULL DEFAULT 0,
    used_by_user_id     VARCHAR(36),
    used_at             DATETIME,
    created_by_admin_id VARCHAR(36) NOT NULL,
    created_at          DATETIME NOT NULL,
    expires_at          DATETIME,                       -- 充值码本身过期时间
    FOREIGN KEY (used_by_user_id) REFERENCES users(id),
    FOREIGN KEY (created_by_admin_id) REFERENCES users(id)
);
CREATE INDEX idx_recharge_codes_code ON recharge_codes(code);
CREATE INDEX idx_recharge_codes_is_used ON recharge_codes(is_used);
```

#### PremiumHistory（会员变动记录表）
```sql
CREATE TABLE premium_history (
    id                  VARCHAR(36) PRIMARY KEY,
    user_id             VARCHAR(36) NOT NULL,
    action              VARCHAR(20) NOT NULL,           -- 'activated' | 'renewed' | 'expired' | 'admin_grant' | 'admin_revoke'
    duration_days       INTEGER,
    recharge_code_id    VARCHAR(36),
    admin_id            VARCHAR(36),
    note                VARCHAR(500),
    created_at          DATETIME NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (recharge_code_id) REFERENCES recharge_codes(id),
    FOREIGN KEY (admin_id) REFERENCES users(id)
);
CREATE INDEX idx_premium_history_user_id ON premium_history(user_id);
```

### 2.2 修改现有表

#### projects 表添加 user_id
```sql
ALTER TABLE projects ADD COLUMN user_id VARCHAR(36) NOT NULL;
CREATE INDEX idx_projects_user_id ON projects(user_id);
```

#### user_templates 表添加 user_id
```sql
ALTER TABLE user_templates ADD COLUMN user_id VARCHAR(36) NOT NULL;
CREATE INDEX idx_user_templates_user_id ON user_templates(user_id);
```

### 2.3 实体关系图

```
User (1) ──────< (N) Project
  │
  ├──────< (N) UserTemplate
  │
  ├────── (1) UserSettings
  │
  ├──────< (N) RechargeCode (used_by)
  │
  ├──────< (N) RechargeCode (created_by, admin only)
  │
  └──────< (N) PremiumHistory
```

---

## 三、数据库迁移脚本

### 3.1 完整迁移脚本

创建文件 `backend/migrations/migrate_to_multi_user.py`:

```python
"""
多用户体系数据库迁移脚本

使用方法:
    cd backend
    python -m migrations.migrate_to_multi_user

功能:
    1. 创建新的用户相关表
    2. 迁移现有 projects 和 user_templates 数据
    3. 创建默认管理员账户
"""
import uuid
import sqlite3
from datetime import datetime
from werkzeug.security import generate_password_hash

DATABASE_PATH = 'instance/database.db'
DEFAULT_ADMIN_USERNAME = 'admin'
DEFAULT_ADMIN_PASSWORD = 'admin123'  # 首次登录后应立即修改


def get_connection():
    conn = sqlite3.connect(DATABASE_PATH)
    conn.row_factory = sqlite3.Row
    return conn


def migrate():
    conn = get_connection()
    cursor = conn.cursor()

    try:
        # ========== Step 1: 创建 users 表 ==========
        print("[1/8] Creating users table...")
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                id VARCHAR(36) PRIMARY KEY,
                username VARCHAR(50) UNIQUE NOT NULL,
                email VARCHAR(100) UNIQUE,
                password_hash VARCHAR(256) NOT NULL,
                role VARCHAR(20) NOT NULL DEFAULT 'user',
                tier VARCHAR(20) NOT NULL DEFAULT 'free',
                premium_expires_at DATETIME,
                is_active BOOLEAN NOT NULL DEFAULT 1,
                created_at DATETIME NOT NULL,
                updated_at DATETIME NOT NULL,
                last_login_at DATETIME
            )
        ''')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_users_username ON users(username)')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_users_tier ON users(tier)')

        # ========== Step 2: 创建默认管理员 ==========
        print("[2/8] Creating default admin user...")
        admin_id = str(uuid.uuid4())
        now = datetime.utcnow().isoformat()
        cursor.execute('''
            INSERT OR IGNORE INTO users (id, username, password_hash, role, tier, is_active, created_at, updated_at)
            VALUES (?, ?, ?, 'admin', 'premium', 1, ?, ?)
        ''', (admin_id, DEFAULT_ADMIN_USERNAME, generate_password_hash(DEFAULT_ADMIN_PASSWORD), now, now))

        # 获取管理员 ID（可能已存在）
        cursor.execute('SELECT id FROM users WHERE username = ?', (DEFAULT_ADMIN_USERNAME,))
        admin_row = cursor.fetchone()
        admin_id = admin_row['id'] if admin_row else admin_id

        # ========== Step 3: 创建 user_settings 表 ==========
        print("[3/8] Creating user_settings table...")
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS user_settings (
                id VARCHAR(36) PRIMARY KEY,
                user_id VARCHAR(36) UNIQUE NOT NULL,
                ai_provider_format VARCHAR(20) DEFAULT 'gemini',
                api_base_url VARCHAR(500),
                api_key VARCHAR(500),
                text_model VARCHAR(100),
                image_model VARCHAR(100),
                image_caption_model VARCHAR(100),
                created_at DATETIME NOT NULL,
                updated_at DATETIME NOT NULL,
                FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
            )
        ''')

        # ========== Step 4: 创建 recharge_codes 表 ==========
        print("[4/8] Creating recharge_codes table...")
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS recharge_codes (
                id VARCHAR(36) PRIMARY KEY,
                code VARCHAR(32) UNIQUE NOT NULL,
                duration_days INTEGER NOT NULL,
                is_used BOOLEAN NOT NULL DEFAULT 0,
                used_by_user_id VARCHAR(36),
                used_at DATETIME,
                created_by_admin_id VARCHAR(36) NOT NULL,
                created_at DATETIME NOT NULL,
                expires_at DATETIME,
                FOREIGN KEY (used_by_user_id) REFERENCES users(id),
                FOREIGN KEY (created_by_admin_id) REFERENCES users(id)
            )
        ''')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_recharge_codes_code ON recharge_codes(code)')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_recharge_codes_is_used ON recharge_codes(is_used)')

        # ========== Step 5: 创建 premium_history 表 ==========
        print("[5/8] Creating premium_history table...")
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS premium_history (
                id VARCHAR(36) PRIMARY KEY,
                user_id VARCHAR(36) NOT NULL,
                action VARCHAR(20) NOT NULL,
                duration_days INTEGER,
                recharge_code_id VARCHAR(36),
                admin_id VARCHAR(36),
                note VARCHAR(500),
                created_at DATETIME NOT NULL,
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (recharge_code_id) REFERENCES recharge_codes(id),
                FOREIGN KEY (admin_id) REFERENCES users(id)
            )
        ''')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_premium_history_user_id ON premium_history(user_id)')

        # ========== Step 6: 迁移 projects 表 ==========
        print("[6/8] Migrating projects table...")

        # 检查 projects 表是否已有 user_id 列
        cursor.execute("PRAGMA table_info(projects)")
        columns = [col['name'] for col in cursor.fetchall()]

        if 'user_id' not in columns:
            # 创建新表
            cursor.execute('''
                CREATE TABLE projects_new (
                    id VARCHAR(36) PRIMARY KEY,
                    user_id VARCHAR(36) NOT NULL,
                    idea_prompt TEXT,
                    outline_text TEXT,
                    description_text TEXT,
                    extra_requirements TEXT,
                    creation_type VARCHAR(20) NOT NULL DEFAULT 'idea',
                    template_image_path VARCHAR(500),
                    status VARCHAR(50) NOT NULL DEFAULT 'DRAFT',
                    created_at DATETIME NOT NULL,
                    updated_at DATETIME NOT NULL,
                    FOREIGN KEY (user_id) REFERENCES users(id)
                )
            ''')

            # 复制数据，所有旧数据归属给 admin
            cursor.execute('''
                INSERT INTO projects_new (id, user_id, idea_prompt, outline_text, description_text,
                    extra_requirements, creation_type, template_image_path, status, created_at, updated_at)
                SELECT id, ?, idea_prompt, outline_text, description_text,
                    extra_requirements, creation_type, template_image_path, status, created_at, updated_at
                FROM projects
            ''', (admin_id,))

            # 删除旧表，重命名新表
            cursor.execute('DROP TABLE projects')
            cursor.execute('ALTER TABLE projects_new RENAME TO projects')
            cursor.execute('CREATE INDEX idx_projects_user_id ON projects(user_id)')
            print(f"    -> Migrated projects to admin user ({admin_id})")
        else:
            print("    -> projects table already has user_id column, skipping...")

        # ========== Step 7: 迁移 user_templates 表 ==========
        print("[7/8] Migrating user_templates table...")

        cursor.execute("PRAGMA table_info(user_templates)")
        columns = [col['name'] for col in cursor.fetchall()]

        if 'user_id' not in columns:
            cursor.execute('''
                CREATE TABLE user_templates_new (
                    id VARCHAR(36) PRIMARY KEY,
                    user_id VARCHAR(36) NOT NULL,
                    name VARCHAR(200),
                    file_path VARCHAR(500) NOT NULL,
                    file_size INTEGER,
                    created_at DATETIME NOT NULL,
                    updated_at DATETIME NOT NULL,
                    FOREIGN KEY (user_id) REFERENCES users(id)
                )
            ''')

            cursor.execute('''
                INSERT INTO user_templates_new (id, user_id, name, file_path, file_size, created_at, updated_at)
                SELECT id, ?, name, file_path, file_size, created_at, updated_at
                FROM user_templates
            ''', (admin_id,))

            cursor.execute('DROP TABLE user_templates')
            cursor.execute('ALTER TABLE user_templates_new RENAME TO user_templates')
            cursor.execute('CREATE INDEX idx_user_templates_user_id ON user_templates(user_id)')
            print(f"    -> Migrated user_templates to admin user ({admin_id})")
        else:
            print("    -> user_templates table already has user_id column, skipping...")

        # ========== Step 8: 提交事务 ==========
        print("[8/8] Committing changes...")
        conn.commit()

        print("\n" + "="*50)
        print("Migration completed successfully!")
        print("="*50)
        print(f"\nDefault admin account created:")
        print(f"  Username: {DEFAULT_ADMIN_USERNAME}")
        print(f"  Password: {DEFAULT_ADMIN_PASSWORD}")
        print(f"  ID: {admin_id}")
        print("\n  Please change the admin password after first login!")

    except Exception as e:
        conn.rollback()
        print(f"\n Migration failed: {e}")
        raise
    finally:
        conn.close()


def rollback():
    """回滚迁移（仅用于开发测试）"""
    conn = get_connection()
    cursor = conn.cursor()

    try:
        print("Rolling back migration...")
        cursor.execute('DROP TABLE IF EXISTS premium_history')
        cursor.execute('DROP TABLE IF EXISTS recharge_codes')
        cursor.execute('DROP TABLE IF EXISTS user_settings')
        cursor.execute('DROP TABLE IF EXISTS users')
        conn.commit()
        print("Rollback completed!")
    finally:
        conn.close()


if __name__ == '__main__':
    import sys
    if len(sys.argv) > 1 and sys.argv[1] == '--rollback':
        rollback()
    else:
        migrate()
```

### 3.2 快速重置方案（开发阶段）

如果不需要保留旧数据，直接删除数据库重建：

```bash
# 删除数据库
rm -f backend/instance/database.db

# 重新启动应用，Flask-SQLAlchemy 会自动创建表
python run.py
```

---

## 四、API 接口设计

### 4.1 认证模块 `/api/auth`

| 方法 | 路径 | 说明 | 权限 | 请求体 |
|------|------|------|------|--------|
| POST | `/register` | 用户注册 | 公开 | `{username, password, email?}` |
| POST | `/login` | 用户登录 | 公开 | `{username, password}` |
| POST | `/logout` | 用户登出 | 登录 | - |
| GET | `/me` | 获取当前用户信息 | 登录 | - |
| PUT | `/password` | 修改密码 | 登录 | `{old_password, new_password}` |
| POST | `/refresh` | 刷新 Token | 登录 | `{refresh_token}` |

### 4.2 用户设置 `/api/user`

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/settings` | 获取个人 AI 设置 | 登录 |
| PUT | `/settings` | 更新个人 AI 设置 | 登录 |
| GET | `/premium-status` | 查看会员状态 | 登录 |

### 4.3 充值模块 `/api/recharge`

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| POST | `/redeem` | 兑换充值码 | 登录 |

### 4.4 管理后台 `/api/admin`

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | `/users` | 用户列表 | 管理员 |
| GET | `/users/{id}` | 用户详情 | 管理员 |
| PUT | `/users/{id}` | 修改用户 | 管理员 |
| POST | `/users/{id}/grant-premium` | 授予高级会员 | 管理员 |
| POST | `/users/{id}/revoke-premium` | 撤销高级会员 | 管理员 |
| GET | `/recharge-codes` | 充值码列表 | 管理员 |
| POST | `/recharge-codes` | 批量生成充值码 | 管理员 |
| DELETE | `/recharge-codes/{id}` | 删除充值码 | 管理员 |
| GET | `/statistics` | 统计数据 | 管理员 |

### 4.5 现有 API 修改

所有数据查询必须添加 `user_id` 过滤：

```python
# 修改前
projects = Project.query.all()

# 修改后
projects = Project.query.filter_by(user_id=current_user.id).all()
```

---

## 五、认证机制

### 5.1 JWT Token 方案

```
┌────────────────────────────────────────────────────────────┐
│                    Token 结构                               │
├────────────────────────────────────────────────────────────┤
│ access_token:  有效期 1 小时                                │
│   payload:                                                 │
│     - user_id: string                                      │
│     - username: string                                     │
│     - role: 'user' | 'admin'                               │
│     - tier: 'free' | 'premium'                             │
│     - exp: timestamp                                       │
│                                                            │
│ refresh_token: 有效期 7 天                                  │
│   payload:                                                 │
│     - user_id: string                                      │
│     - exp: timestamp                                       │
└────────────────────────────────────────────────────────────┘
```

### 5.2 认证流程

```
  登录流程:
  ┌──────────┐     POST /auth/login      ┌──────────┐
  │  前端    │ ─────────────────────────>│  后���    │
  │          │  {username, password}     │          │
  │          │                           │          │
  │          │ <─────────────────────────│          │
  │          │  {access_token,           │          │
  │          │   refresh_token, user}    │          │
  └──────────┘                           └──────────┘
       │
       │ 存储到 localStorage
       ▼

  API 请求:
  ┌──────────┐     GET /api/projects     ┌──────────┐
  │  前端    │ ─────────────────────────>│  后端    │
  │          │  Headers:                 │          │
  │          │  Authorization:           │          │
  │          │  Bearer <access_token>    │          │
  └──────────┘                           └──────────┘
```

---

## 六、Settings 使用逻辑

### 6.1 获取有效设置的逻辑

```python
def get_effective_settings(user: User) -> dict:
    """
    根据用户等级获取有效的 AI 配置

    - 高级用户（未过期）：使用全局 Settings
    - 普通用户：使用个人 UserSettings
    """
    from datetime import datetime

    # 检查是否为有效高级用户
    is_premium = (
        user.tier == 'premium' and
        user.premium_expires_at and
        user.premium_expires_at > datetime.utcnow()
    )

    if is_premium:
        # 高级用户使用全局设置
        global_settings = Settings.get_settings()
        return {
            'ai_provider_format': global_settings.ai_provider_format,
            'api_base_url': global_settings.api_base_url,
            'api_key': global_settings.api_key,
            'text_model': global_settings.text_model,
            'image_model': global_settings.image_model,
            # ... 其他字段
        }
    else:
        # 普通用户使用个人设置
        user_settings = UserSettings.query.filter_by(user_id=user.id).first()

        if not user_settings or not user_settings.api_key:
            raise APIKeyNotConfiguredError(
                "请先在个人设置中配置 API Key 才能使用 AI 功能"
            )

        return {
            'ai_provider_format': user_settings.ai_provider_format,
            'api_base_url': user_settings.api_base_url,
            'api_key': user_settings.api_key,
            'text_model': user_settings.text_model,
            'image_model': user_settings.image_model,
            # ... 其他字段
        }
```

### 6.2 流程图

```
用户发起 AI 请求
        │
        ▼
┌─────────────────┐
│ 检查用户 tier   │
└────────┬────────┘
         │
   ┌─────┴─────┐
   │           │
   ▼           ▼
premium      free
   │           │
   ▼           ▼
┌────────┐  ┌─────────────────┐
│检查是否│  │获取 UserSettings│
│未过期  │  └────────┬────────┘
└───┬────┘           │
    │           ┌────┴────┐
 ┌──┴──┐        │         │
 │     │        ▼         ▼
 ▼     ▼     有 API Key  无 API Key
是    否        │         │
 │     │        ▼         ▼
 ▼     ▼     使用个人  返回错误
使用   降级为   设置    "请配置API"
全局   free
设置
```

---

## 七、前端改造

### 7.1 新增页面

| 路由 | 组件 | 说明 |
|------|------|------|
| `/login` | LoginPage | 登录页 |
| `/register` | RegisterPage | 注册页 |
| `/profile` | ProfilePage | 个人中心 |
| `/profile/settings` | UserSettingsPage | 个人 AI 设置 |
| `/profile/premium` | PremiumPage | 会员状态/充值 |
| `/admin` | AdminDashboard | 管理后台首页 |
| `/admin/users` | AdminUsersPage | 用户管理 |
| `/admin/recharge-codes` | AdminCodesPage | 充值码管理 |

### 7.2 路由守卫

```typescript
// 路由配置
const routes = [
  { path: '/login', element: <LoginPage />, public: true },
  { path: '/register', element: <RegisterPage />, public: true },
  { path: '/admin/*', element: <AdminLayout />, requireAdmin: true },
  { path: '/*', element: <MainLayout />, requireAuth: true },
];
```

### 7.3 API 拦截器改造（关键）

**现有 `frontend/src/api/client.ts` 缺少 Authorization Header！**

必须修改以确保多用户隔离生效：

```typescript
// frontend/src/api/client.ts

import axios from 'axios';

const API_BASE_URL = '';

export const apiClient = axios.create({
  baseURL: API_BASE_URL,
  timeout: 300000,
});

// 请求拦截器 - 添加 Authorization Header
apiClient.interceptors.request.use(
  (config) => {
    // 关键：每次请求都带上 Token
    const token = localStorage.getItem('access_token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }

    // FormData 处理
    if (config.data instanceof FormData) {
      if (config.headers) {
        delete config.headers['Content-Type'];
      }
    } else if (config.headers && !config.headers['Content-Type']) {
      config.headers['Content-Type'] = 'application/json';
    }

    return config;
  },
  (error) => Promise.reject(error)
);

// 响应拦截器 - 处理 401 错误
apiClient.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;

    // 关键：401 错误处理
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;

      // 尝试刷新 Token
      const refreshToken = localStorage.getItem('refresh_token');
      if (refreshToken) {
        try {
          const response = await axios.post('/api/auth/refresh', {
            refresh_token: refreshToken
          });
          const { access_token } = response.data;
          localStorage.setItem('access_token', access_token);
          originalRequest.headers.Authorization = `Bearer ${access_token}`;
          return apiClient(originalRequest);
        } catch (refreshError) {
          // 刷新失败，跳转登录页
          localStorage.removeItem('access_token');
          localStorage.removeItem('refresh_token');
          window.location.href = '/login';
          return Promise.reject(refreshError);
        }
      } else {
        // 无 refresh_token，跳转登录页
        window.location.href = '/login';
      }
    }

    return Promise.reject(error);
  }
);

export default apiClient;
```

### 7.4 用户状态管理

新增 `frontend/src/store/useAuthStore.ts`:

```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface User {
  id: string;
  username: string;
  email?: string;
  role: 'user' | 'admin';
  tier: 'free' | 'premium';
  premium_expires_at?: string;
}

interface AuthState {
  user: User | null;
  accessToken: string | null;
  refreshToken: string | null;
  isAuthenticated: boolean;
  isPremium: boolean;
  isAdmin: boolean;

  login: (username: string, password: string) => Promise<void>;
  logout: () => void;
  refreshAccessToken: () => Promise<void>;
  checkPremiumStatus: () => boolean;
  setUser: (user: User) => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      user: null,
      accessToken: null,
      refreshToken: null,
      isAuthenticated: false,
      isPremium: false,
      isAdmin: false,

      login: async (username, password) => {
        // 实现登录逻辑
      },

      logout: () => {
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
        set({
          user: null,
          accessToken: null,
          refreshToken: null,
          isAuthenticated: false,
          isPremium: false,
          isAdmin: false,
        });
      },

      // ... 其他方法
    }),
    {
      name: 'auth-storage',
    }
  )
);
```

---

## 八、文件结构变更

```
backend/
├── models/
│   ├── user.py              # 新增
│   ├── user_settings.py     # 新增
│   ├── recharge_code.py     # 新增
│   ├── premium_history.py   # 新增
│   ├── project.py           # 修改: 添加 user_id
│   └── user_template.py     # 修改: 添加 user_id
│
├── controllers/
│   ├── auth_controller.py   # 新增
│   ├── user_controller.py   # 新增
│   ├── admin_controller.py  # 新增
│   └── ...                  # 修改: 添加用户过滤
│
├── middleware/
│   └── auth.py              # 新增: JWT 认证中间件
│
├── migrations/
│   └── migrate_to_multi_user.py  # 新增: 迁移脚本
│
└── utils/
    └── auth_utils.py        # 新增: 密码哈希、Token 生成

frontend/src/
├── pages/
│   ├── auth/
│   │   ├── Login.tsx        # 新增
│   │   └── Register.tsx     # 新增
│   ├── profile/
│   │   ├── Profile.tsx      # 新增
│   │   ├── UserSettings.tsx # 新增
│   │   └── Premium.tsx      # 新增
│   └── admin/
│       ├── Dashboard.tsx    # 新增
│       ├── Users.tsx        # 新增
│       └── RechargeCodes.tsx# 新增
│
├── store/
│   └── useAuthStore.ts      # 新增
│
├── api/
│   ├── client.ts            # 修改: 添加 Auth Header
│   ├── auth.ts              # 新增
│   └── admin.ts             # 新增
│
└── components/
    ├── AuthGuard.tsx        # 新增
    └── AdminGuard.tsx       # 新增
```

---

## 九、实现计划

### Phase 1 - 核心认证（必须优先完成）

- [ ] 创建 User 模型
- [ ] 实现注册/登录 API
- [ ] 实现 JWT 认证中间件
- [ ] 修改 Project 模型添加 user_id
- [ ] 修改 UserTemplate 模型添加 user_id
- [ ] 创建数据库迁移脚本
- [ ] 修改所有 Controller 添加用户过滤
- [ ] 前端登录/注册页面
- [ ] 前端 API 拦截器添加 Auth Header
- [ ] 前端路由守卫

### Phase 2 - 用户设置

- [ ] 创建 UserSettings 模型
- [ ] 实现用户设置 API
- [ ] 实现 `get_effective_settings()` 逻辑
- [ ] 修改 AIService 使用有效设置
- [ ] 前端个人设置页面

### Phase 3 - 会员体系

- [ ] 创建 RechargeCode 模型
- [ ] 创建 PremiumHistory 模型
- [ ] 实现充值码兑换 API
- [ ] 实现会员状态检查逻辑
- [ ] 前端会员状态展示
- [ ] 前端充值码兑换页面

### Phase 4 - 管理后台

- [ ] 实现管理员 API
- [ ] 用户管理页面
- [ ] 充值码管理页面（批量生成）
- [ ] 手动授权/撤销功能
- [ ] 统计仪表盘

---

## 十、安全注意事项

1. **密码存储**: 使用 `werkzeug.security.generate_password_hash` 加密
2. **JWT 密钥**: 使用强随机密钥，存储在环境变量中
3. **Token 过期**: access_token 短期有效（1h），refresh_token ��期有效（7d）
4. **SQL 注入**: 使用 SQLAlchemy ORM，避免拼接 SQL
5. **XSS 防护**: React 默认转义输出
6. **CORS**: 仅允许同源请求或配置白名单
